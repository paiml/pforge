<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pre-Commit Hooks - pforge: EXTREME TDD for MCP Servers</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Build production-ready MCP servers with EXTREME Test-Driven Development - 5-minute cycles, zero tolerance quality gates">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">pforge: EXTREME TDD for MCP Servers</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/paiml/pforge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/paiml/pforge/edit/main/pforge-book/src/ch08-01-pre-commit.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pre-commit-hooks-automated-quality-enforcement"><a class="header" href="#pre-commit-hooks-automated-quality-enforcement">Pre-Commit Hooks: Automated Quality Enforcement</a></h1>
<p>Pre-commit hooks are Git‚Äôs mechanism for running automated checks before allowing a commit. They enforce quality standards at the exact moment code enters version control‚Äîthe last line of defense before technical debt infiltrates your codebase.</p>
<p>pforge uses pre-commit hooks to run all eight quality gates automatically. Every commit must pass these gates. No exceptions (unless you use <code>--no-verify</code>, which you shouldn‚Äôt).</p>
<p>This chapter explains how pforge‚Äôs pre-commit hooks work, how to install them, how to debug failures, and how to customize them for your workflow.</p>
<h2 id="the-pre-commit-workflow"><a class="header" href="#the-pre-commit-workflow">The Pre-Commit Workflow</a></h2>
<p>Here‚Äôs what happens when you attempt to commit:</p>
<ol>
<li><strong>You run</strong>: <code>git commit -m "Your message"</code></li>
<li><strong>Git triggers</strong>: <code>.git/hooks/pre-commit</code> (if it exists and is executable)</li>
<li><strong>Hook runs</strong>: All quality gate checks sequentially</li>
<li><strong>Hook returns</strong>:
<ul>
<li><strong>Exit 0</strong> (success): Commit proceeds normally</li>
<li><strong>Exit 1</strong> (failure): Commit is blocked, changes remain staged</li>
</ul>
</li>
</ol>
<p>The entire process is transparent. You see exactly which checks run and which fail.</p>
<h2 id="installing-pre-commit-hooks"><a class="header" href="#installing-pre-commit-hooks">Installing Pre-Commit Hooks</a></h2>
<p>pforge projects come with a pre-commit hook in <code>.git/hooks/pre-commit</code>. If you cloned the repository, you already have it. If you‚Äôre setting up a new project:</p>
<h3 id="option-1-copy-from-template"><a class="header" href="#option-1-copy-from-template">Option 1: Copy from Template</a></h3>
<pre><code class="language-bash"># From pforge root directory
cp .git/hooks/pre-commit.sample .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
</code></pre>
<h3 id="option-2-create-manually"><a class="header" href="#option-2-create-manually">Option 2: Create Manually</a></h3>
<p>Create <code>.git/hooks/pre-commit</code>:</p>
<pre><code class="language-bash">#!/bin/bash
# pforge pre-commit hook - PMAT Quality Gate Enforcement

set -e

echo "üîí pforge Quality Gate - Pre-Commit Checks"
echo "=========================================="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
FAIL=0

# 0. Markdown Link Validation
echo ""
echo "üîó 0/8 Validating markdown links..."
if command -v pmat &amp;&gt; /dev/null; then
    if pmat validate-docs --fail-on-error &gt; /dev/null 2&gt;&amp;1; then
        echo -e "${GREEN}‚úì${NC} All markdown links valid"
    else
        echo -e "${RED}‚úó${NC} Broken markdown links found"
        pmat validate-docs --fail-on-error
        FAIL=1
    fi
else
    echo -e "${YELLOW}‚ö†${NC}  pmat not installed, skipping link validation"
    echo "   Install: cargo install pmat"
fi

# 1. Code Formatting
echo ""
echo "üìù 1/8 Checking code formatting..."
if cargo fmt --check --quiet; then
    echo -e "${GREEN}‚úì${NC} Formatting passed"
else
    echo -e "${RED}‚úó${NC} Formatting failed - run: cargo fmt"
    FAIL=1
fi

# 2. Linting
echo ""
echo "üîç 2/8 Running clippy lints..."
if cargo clippy --all-targets --all-features --quiet -- -D warnings 2&gt;&amp;1 | grep -q "warning\|error"; then
    echo -e "${RED}‚úó${NC} Clippy warnings/errors found"
    cargo clippy --all-targets --all-features -- -D warnings
    FAIL=1
else
    echo -e "${GREEN}‚úì${NC} Clippy passed"
fi

# 3. Tests
echo ""
echo "üß™ 3/8 Running tests..."
if cargo test --quiet --all 2&gt;&amp;1 | grep -q "test result:.*FAILED"; then
    echo -e "${RED}‚úó${NC} Tests failed"
    cargo test --all
    FAIL=1
else
    echo -e "${GREEN}‚úì${NC} All tests passed"
fi

# 4. Complexity Analysis
echo ""
echo "üî¨ 4/8 Analyzing code complexity..."
if pmat analyze complexity --max-cyclomatic 20 --format summary 2&gt;&amp;1 | grep -q "VIOLATION\|exceeds"; then
    echo -e "${RED}‚úó${NC} Complexity violations found (max: 20)"
    pmat analyze complexity --max-cyclomatic 20
    FAIL=1
else
    echo -e "${GREEN}‚úì${NC} Complexity check passed"
fi

# 5. SATD Detection
echo ""
echo "üìã 5/8 Checking for technical debt comments..."
if pmat analyze satd --format summary 2&gt;&amp;1 | grep -q "TODO\|FIXME\|HACK\|XXX"; then
    echo -e "${YELLOW}‚ö†${NC}  SATD comments found (Phase 2-4 markers allowed)"
    # Only fail on non-phase markers
    if pmat analyze satd --format summary 2&gt;&amp;1 | grep -v "Phase [234]" | grep -q "TODO\|FIXME\|HACK"; then
        echo -e "${RED}‚úó${NC} Non-phase SATD comments found"
        pmat analyze satd
        FAIL=1
    else
        echo -e "${GREEN}‚úì${NC} Only phase markers present (allowed)"
    fi
else
    echo -e "${GREEN}‚úì${NC} No SATD comments"
fi

# 6. Coverage Check
echo ""
echo "üìä 6/8 Checking code coverage..."
if command -v cargo-llvm-cov &amp;&gt; /dev/null; then
    if cargo llvm-cov --summary-only 2&gt;&amp;1 | grep -E "[0-9]+\.[0-9]+%" | awk '{if ($1 &lt; 80.0) exit 1}'; then
        echo -e "${GREEN}‚úì${NC} Coverage ‚â•80%"
    else
        echo -e "${RED}‚úó${NC} Coverage &lt;80% - run: make coverage"
        FAIL=1
    fi
else
    echo -e "${YELLOW}‚ö†${NC}  cargo-llvm-cov not installed, skipping coverage check"
    echo "   Install: cargo install cargo-llvm-cov"
fi

# 7. TDG Score
echo ""
echo "üìà 7/8 Calculating Technical Debt Grade..."
if pmat tdg . 2&gt;&amp;1 | grep -E "Grade: [A-F]" | grep -q "[D-F]"; then
    echo -e "${RED}‚úó${NC} TDG Grade below threshold (need: C+ or better)"
    pmat tdg .
    FAIL=1
else
    echo -e "${GREEN}‚úì${NC} TDG Grade passed"
fi

# Summary
echo ""
echo "=========================================="
if [ $FAIL -eq 1 ]; then
    echo -e "${RED}‚ùå Quality Gate FAILED${NC}"
    echo ""
    echo "Fix the issues above and try again."
    echo "To bypass (NOT recommended): git commit --no-verify"
    exit 1
else
    echo -e "${GREEN}‚úÖ Quality Gate PASSED${NC}"
    echo ""
    echo "All quality checks passed. Proceeding with commit."
    exit 0
fi
</code></pre>
<p>Make it executable:</p>
<pre><code class="language-bash">chmod +x .git/hooks/pre-commit
</code></pre>
<h3 id="verifying-installation"><a class="header" href="#verifying-installation">Verifying Installation</a></h3>
<p>Test the hook without committing:</p>
<pre><code class="language-bash">./.git/hooks/pre-commit
</code></pre>
<p>You should see the quality gate checks run. If the hook isn‚Äôt found or isn‚Äôt executable:</p>
<pre><code class="language-bash"># Check if file exists
ls -la .git/hooks/pre-commit

# Make executable
chmod +x .git/hooks/pre-commit

# Verify
./.git/hooks/pre-commit
</code></pre>
<h2 id="understanding-hook-output"><a class="header" href="#understanding-hook-output">Understanding Hook Output</a></h2>
<p>When you commit, the hook produces detailed output for each gate:</p>
<h3 id="successful-run"><a class="header" href="#successful-run">Successful Run</a></h3>
<pre><code class="language-bash">git commit -m "feat: add user authentication"

üîí pforge Quality Gate - Pre-Commit Checks
==========================================

üîó 0/8 Validating markdown links...
‚úì All markdown links valid

üìù 1/8 Checking code formatting...
‚úì Formatting passed

üîç 2/8 Running clippy lints...
‚úì Clippy passed

üß™ 3/8 Running tests...
‚úì All tests passed

üî¨ 4/8 Analyzing code complexity...
‚úì Complexity check passed

üìã 5/8 Checking for technical debt comments...
‚úì Only phase markers present (allowed)

üìä 6/8 Checking code coverage...
‚úì Coverage ‚â•80%

üìà 7/8 Calculating Technical Debt Grade...
‚úì TDG Grade passed

==========================================
‚úÖ Quality Gate PASSED

All quality checks passed. Proceeding with commit.
[main f3a8c21] feat: add user authentication
 3 files changed, 127 insertions(+), 5 deletions(-)
</code></pre>
<p>The commit succeeds. Your changes are committed with confidence.</p>
<h3 id="failed-run-formatting"><a class="header" href="#failed-run-formatting">Failed Run: Formatting</a></h3>
<pre><code class="language-bash">git commit -m "feat: add broken feature"

üîí pforge Quality Gate - Pre-Commit Checks
==========================================

üîó 0/8 Validating markdown links...
‚úì All markdown links valid

üìù 1/8 Checking code formatting...
‚úó Formatting failed - run: cargo fmt

==========================================
‚ùå Quality Gate FAILED

Fix the issues above and try again.
To bypass (NOT recommended): git commit --no-verify
</code></pre>
<p>The commit is blocked. Fix formatting:</p>
<pre><code class="language-bash">cargo fmt
git add .
git commit -m "feat: add broken feature"
</code></pre>
<h3 id="failed-run-tests"><a class="header" href="#failed-run-tests">Failed Run: Tests</a></h3>
<pre><code class="language-bash">git commit -m "feat: add untested feature"

...
üß™ 3/8 Running tests...
‚úó Tests failed

running 15 tests
test auth::tests::test_login ... ok
test auth::tests::test_logout ... FAILED
test auth::tests::test_session ... ok
...

failures:

---- auth::tests::test_logout stdout ----
thread 'auth::tests::test_logout' panicked at 'assertion failed:
  `(left == right)`
  left: `Some("user123")`,
  right: `None`'

failures:
    auth::tests::test_logout

test result: FAILED. 14 passed; 1 failed

==========================================
‚ùå Quality Gate FAILED
</code></pre>
<p>The commit is blocked. Debug and fix the failing test:</p>
<pre><code class="language-bash"># Fix the test or implementation
cargo test auth::tests::test_logout

# Once fixed, commit again
git commit -m "feat: add untested feature"
</code></pre>
<h3 id="failed-run-complexity"><a class="header" href="#failed-run-complexity">Failed Run: Complexity</a></h3>
<pre><code class="language-bash">git commit -m "feat: add complex handler"

...
üî¨ 4/8 Analyzing code complexity...
‚úó Complexity violations found (max: 20)

Function 'handle_request' has cyclomatic complexity 24 (max: 20)
  Location: src/handlers/auth.rs:89
  Recommendation: Extract helper functions or simplify logic

==========================================
‚ùå Quality Gate FAILED
</code></pre>
<p>The commit is blocked. Refactor to reduce complexity:</p>
<pre><code class="language-bash"># Refactor the complex function
# Extract helpers, simplify branches
cargo test  # Ensure tests still pass
git add .
git commit -m "feat: add complex handler"
</code></pre>
<h3 id="failed-run-coverage"><a class="header" href="#failed-run-coverage">Failed Run: Coverage</a></h3>
<pre><code class="language-bash">git commit -m "feat: add uncovered code"

...
üìä 6/8 Checking code coverage...
‚úó Coverage &lt;80% - run: make coverage

Filename                      Lines    Covered    Uncovered    %
------------------------------------------------------------
src/handlers/auth.rs          156      98         58          62.8%
------------------------------------------------------------

==========================================
‚ùå Quality Gate FAILED
</code></pre>
<p>The commit is blocked. Add tests to increase coverage:</p>
<pre><code class="language-bash"># Add tests for uncovered code paths
make coverage  # See detailed coverage report
# Write missing tests
cargo test
git add .
git commit -m "feat: add uncovered code"
</code></pre>
<h2 id="hook-performance"><a class="header" href="#hook-performance">Hook Performance</a></h2>
<p>Pre-commit hooks add latency to commits. Here‚Äôs typical timing:</p>
<div class="table-wrapper"><table><thead><tr><th>Gate</th><th>Time (avg)</th><th>Notes</th></tr></thead><tbody>
<tr><td>Link validation</td><td>~500ms</td><td>Depends on doc count and network for HTTP checks</td></tr>
<tr><td>Formatting check</td><td>~100ms</td><td>Very fast, just checks diffs</td></tr>
<tr><td>Clippy</td><td>~2-5s</td><td>First run slow, incremental fast</td></tr>
<tr><td>Tests</td><td>~1-10s</td><td>Depends on test count and parallelization</td></tr>
<tr><td>Complexity</td><td>~300ms</td><td>Analyzes function metrics</td></tr>
<tr><td>SATD</td><td>~200ms</td><td>Text search across codebase</td></tr>
<tr><td>Coverage</td><td>~5-15s</td><td>Slowest gate, instruments and re-runs tests</td></tr>
<tr><td>TDG</td><td>~1-2s</td><td>Holistic quality analysis</td></tr>
</tbody></table>
</div>
<p><strong>Total</strong>: ~10-35 seconds for a full run.</p>
<p>Slow commits are frustrating, but the alternative‚Äîbroken code entering the repository‚Äîis worse. Over time, you‚Äôll appreciate the peace of mind.</p>
<h3 id="optimizing-hook-performance"><a class="header" href="#optimizing-hook-performance">Optimizing Hook Performance</a></h3>
<p><strong>1. Skip Coverage for Trivial Commits</strong></p>
<p>Coverage is the slowest gate. For small changes (doc updates, minor refactors), you might skip it:</p>
<pre><code class="language-bash"># Modify .git/hooks/pre-commit
# Comment out the coverage section for local development
# Or make it conditional:

if [ -z "$SKIP_COVERAGE" ]; then
    # Coverage check here
fi
</code></pre>
<p>Then:</p>
<pre><code class="language-bash">SKIP_COVERAGE=1 git commit -m "docs: fix typo"
</code></pre>
<p><strong>Caution</strong>: Skipping coverage can let untested code slip through. Use sparingly.</p>
<p><strong>2. Use Incremental Compilation</strong></p>
<p>Ensure incremental compilation is enabled in <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[profile.dev]
incremental = true
</code></pre>
<p>This speeds up Clippy and test runs by reusing previous compilation artifacts.</p>
<p><strong>3. Run Checks Manually First</strong></p>
<p>Before committing, run quality gates manually during development:</p>
<pre><code class="language-bash"># During TDD cycle
cargo watch -x 'test --lib --quiet' -x 'clippy --quiet'

# Before commit
make quality-gate
git commit -m "Your message"  # Faster, checks already passed
</code></pre>
<p>The pre-commit hook then serves as a final safety check, not the first discovery of issues.</p>
<h2 id="debugging-hook-failures"><a class="header" href="#debugging-hook-failures">Debugging Hook Failures</a></h2>
<p>When a hook fails, follow this debugging workflow:</p>
<h3 id="1-identify-which-gate-failed"><a class="header" href="#1-identify-which-gate-failed">1. Identify Which Gate Failed</a></h3>
<p>The hook output clearly shows which gate failed:</p>
<pre><code>üîç 2/8 Running clippy lints...
‚úó Clippy warnings/errors found
</code></pre>
<h3 id="2-run-the-gate-manually"><a class="header" href="#2-run-the-gate-manually">2. Run the Gate Manually</a></h3>
<p>Run the failing check outside the hook for better output:</p>
<pre><code class="language-bash">cargo clippy --all-targets --all-features -- -D warnings
</code></pre>
<h3 id="3-fix-the-issue"><a class="header" href="#3-fix-the-issue">3. Fix the Issue</a></h3>
<p>Address the specific problem:</p>
<ul>
<li><strong>Formatting</strong>: Run <code>cargo fmt</code></li>
<li><strong>Clippy</strong>: Fix warnings or add <code>#[allow(clippy::...)]</code></li>
<li><strong>Tests</strong>: Debug failing tests</li>
<li><strong>Complexity</strong>: Refactor complex functions</li>
<li><strong>SATD</strong>: Remove or fix technical debt comments</li>
<li><strong>Coverage</strong>: Add missing tests</li>
<li><strong>TDG</strong>: Improve lowest-scoring components</li>
</ul>
<h3 id="4-verify-the-fix"><a class="header" href="#4-verify-the-fix">4. Verify the Fix</a></h3>
<p>Run the gate again to confirm:</p>
<pre><code class="language-bash">cargo clippy --all-targets --all-features -- -D warnings
</code></pre>
<h3 id="5-re-attempt-commit"><a class="header" href="#5-re-attempt-commit">5. Re-attempt Commit</a></h3>
<p>Once fixed, commit again:</p>
<pre><code class="language-bash">git add .
git commit -m "Your message"
</code></pre>
<h3 id="common-pitfalls"><a class="header" href="#common-pitfalls">Common Pitfalls</a></h3>
<p><strong>Hook Not Running</strong></p>
<p>If the hook doesn‚Äôt run at all:</p>
<pre><code class="language-bash"># Check if file exists
ls -la .git/hooks/pre-commit

# Check if executable
chmod +x .git/hooks/pre-commit

# Verify shebang
head -n1 .git/hooks/pre-commit  # Should be #!/bin/bash
</code></pre>
<p><strong>Missing Dependencies</strong></p>
<p>If the hook fails because <code>pmat</code> or <code>cargo-llvm-cov</code> isn‚Äôt installed:</p>
<pre><code class="language-bash"># Install pmat
cargo install pmat

# Install cargo-llvm-cov
cargo install cargo-llvm-cov
</code></pre>
<p>The hook gracefully skips checks for missing tools, but you should install them for full protection.</p>
<p><strong>Staged vs. Unstaged Changes</strong></p>
<p>The hook runs on <strong>staged changes</strong>, not all changes in your working directory:</p>
<pre><code class="language-bash"># Only staged changes are checked
git add src/main.rs
git commit -m "Update main"  # Hook checks src/main.rs only

# To check all changes, stage everything
git add .
git commit -m "Update all"
</code></pre>
<h2 id="bypassing-the-hook-emergency-only"><a class="header" href="#bypassing-the-hook-emergency-only">Bypassing the Hook (Emergency Only)</a></h2>
<p>In rare emergencies, bypass the hook with <code>--no-verify</code>:</p>
<pre><code class="language-bash">git commit --no-verify -m "hotfix: critical production bug"
</code></pre>
<p><strong>When to bypass:</strong></p>
<ul>
<li>Critical production hotfix where seconds matter</li>
<li>Hook infrastructure is broken (e.g., pmat server down)</li>
<li>You‚Äôre committing known-failing code to share with teammates for debugging</li>
</ul>
<p><strong>When NOT to bypass:</strong></p>
<ul>
<li>‚ÄúI‚Äôm in a hurry‚Äù</li>
<li>‚ÄúI‚Äôll fix it in the next commit‚Äù</li>
<li>‚ÄúThe failing test is flaky anyway‚Äù</li>
<li>‚ÄúCoverage is annoying‚Äù</li>
</ul>
<p>Every bypass creates technical debt. Document why you bypassed and create a follow-up task.</p>
<h3 id="logging-bypasses"><a class="header" href="#logging-bypasses">Logging Bypasses</a></h3>
<p>Add logging to track bypasses:</p>
<pre><code class="language-bash"># In .git/hooks/pre-commit, at the top:
if [ "$1" = "--no-verify" ]; then
    echo "‚ö†Ô∏è  BYPASS: Quality gates skipped" &gt;&gt; .git/bypass.log
    echo "  Date: $(date)" &gt;&gt; .git/bypass.log
    echo "  User: $(git config user.name)" &gt;&gt; .git/bypass.log
    echo "" &gt;&gt; .git/bypass.log
fi
</code></pre>
<p>Review <code>.git/bypass.log</code> periodically. Frequent bypasses indicate process problems.</p>
<h2 id="customizing-pre-commit-hooks"><a class="header" href="#customizing-pre-commit-hooks">Customizing Pre-Commit Hooks</a></h2>
<p>Every project has unique needs. Customize the hook to match your workflow.</p>
<h3 id="adding-custom-checks"><a class="header" href="#adding-custom-checks">Adding Custom Checks</a></h3>
<p>Add project-specific checks:</p>
<pre><code class="language-bash"># In .git/hooks/pre-commit, after gate 7:

# 8. Custom Security Audit
echo ""
echo "üîê 8/9 Running security audit..."
if cargo audit 2&gt;&amp;1 | grep -q "error\|vulnerability"; then
    echo -e "${RED}‚úó${NC} Security vulnerabilities found"
    cargo audit
    FAIL=1
else
    echo -e "${GREEN}‚úì${NC} No vulnerabilities detected"
fi
</code></pre>
<h3 id="removing-checks"><a class="header" href="#removing-checks">Removing Checks</a></h3>
<p>Comment out checks you don‚Äôt need:</p>
<pre><code class="language-bash"># Skip SATD for projects that allow TODO comments
# 5. SATD Detection
# echo ""
# echo "üìã 5/8 Checking for technical debt comments..."
# ...
</code></pre>
<h3 id="conditional-checks"><a class="header" href="#conditional-checks">Conditional Checks</a></h3>
<p>Run certain checks only in specific contexts:</p>
<pre><code class="language-bash"># Only check coverage on CI, not locally
if [ -n "$CI" ]; then
    echo ""
    echo "üìä 6/8 Checking code coverage..."
    # Coverage check here
fi
</code></pre>
<h3 id="per-branch-checks"><a class="header" href="#per-branch-checks">Per-Branch Checks</a></h3>
<p>Different branches might have different requirements:</p>
<pre><code class="language-bash">BRANCH=$(git branch --show-current)

if [ "$BRANCH" = "main" ]; then
    # Strict checks for main
    MIN_COVERAGE=90
else
    # Relaxed checks for feature branches
    MIN_COVERAGE=80
fi
</code></pre>
<h3 id="speed-vs-safety-trade-offs"><a class="header" href="#speed-vs-safety-trade-offs">Speed vs. Safety Trade-offs</a></h3>
<p>For faster local development:</p>
<pre><code class="language-bash"># Quick mode: Skip slow checks
if [ -z "$STRICT" ]; then
    echo "Running quick checks (set STRICT=1 for full checks)"
    # Skip coverage and TDG
else
    # Full checks
fi
</code></pre>
<p>Then:</p>
<pre><code class="language-bash"># Fast commit
git commit -m "wip: quick iteration"

# Strict commit
STRICT=1 git commit -m "feat: ready for review"
</code></pre>
<h2 id="integration-with-cicd"><a class="header" href="#integration-with-cicd">Integration with CI/CD</a></h2>
<p>Pre-commit hooks provide local enforcement. CI/CD provides remote enforcement.</p>
<h3 id="dual-enforcement-strategy"><a class="header" href="#dual-enforcement-strategy">Dual Enforcement Strategy</a></h3>
<p>Run the same checks in both places:</p>
<p><strong>Locally</strong> (<code>.git/hooks/pre-commit</code>):</p>
<ul>
<li>Fast feedback</li>
<li>Prevent bad commits</li>
<li>Developer-friendly</li>
</ul>
<p><strong>CI</strong> (<code>.github/workflows/quality.yml</code>):</p>
<ul>
<li>Mandatory for PRs</li>
<li>Can‚Äôt be bypassed</li>
<li>Enforces team standards</li>
</ul>
<h3 id="keeping-them-in-sync"><a class="header" href="#keeping-them-in-sync">Keeping Them in Sync</a></h3>
<p>Define checks once, use everywhere:</p>
<pre><code class="language-bash"># scripts/quality-checks.sh
#!/bin/bash

cargo fmt --check
cargo clippy -- -D warnings
cargo test --all
pmat analyze complexity --max-cyclomatic 20
pmat analyze satd
cargo llvm-cov --summary-only
pmat tdg .
</code></pre>
<p><strong>Pre-commit hook</strong>:</p>
<pre><code class="language-bash"># .git/hooks/pre-commit
./scripts/quality-checks.sh || exit 1
</code></pre>
<p><strong>CI workflow</strong>:</p>
<pre><code class="language-yaml"># .github/workflows/quality.yml
- name: Quality Gates
  run: ./scripts/quality-checks.sh
</code></pre>
<p>Now local and CI use identical checks.</p>
<h2 id="team-adoption-strategies"><a class="header" href="#team-adoption-strategies">Team Adoption Strategies</a></h2>
<p>Introducing pre-commit hooks to a team requires buy-in:</p>
<h3 id="1-start-optional"><a class="header" href="#1-start-optional">1. Start Optional</a></h3>
<p>Make hooks opt-in initially:</p>
<pre><code class="language-bash"># Add to README.md
## Optional: Install Pre-Commit Hooks

cp scripts/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
</code></pre>
<p>As developers see the value, adoption grows organically.</p>
<h3 id="2-gradual-rollout"><a class="header" href="#2-gradual-rollout">2. Gradual Rollout</a></h3>
<p>Enable checks incrementally:</p>
<p><strong>Week 1</strong>: Formatting and linting only
<strong>Week 2</strong>: Add tests
<strong>Week 3</strong>: Add complexity and SATD
<strong>Week 4</strong>: Add coverage and TDG</p>
<p>This avoids overwhelming the team.</p>
<h3 id="3-make-bypasses-visible"><a class="header" href="#3-make-bypasses-visible">3. Make Bypasses Visible</a></h3>
<p>Require documentation for bypasses:</p>
<pre><code class="language-bash">git commit --no-verify -m "hotfix: production down"

# Then immediately create a task:
# TODO: Address quality gate failures from hotfix commit abc1234
</code></pre>
<h3 id="4-celebrate-wins"><a class="header" href="#4-celebrate-wins">4. Celebrate Wins</a></h3>
<p>Highlight how hooks catch bugs:</p>
<p>‚ÄúPre-commit hook caught an unused variable that would have caused a production error. Quality gates work!‚Äù</p>
<p>Positive reinforcement encourages adoption.</p>
<h2 id="advanced-hook-patterns"><a class="header" href="#advanced-hook-patterns">Advanced Hook Patterns</a></h2>
<h3 id="selective-execution"><a class="header" href="#selective-execution">Selective Execution</a></h3>
<p>Run expensive checks only for specific files:</p>
<pre><code class="language-bash"># Get changed files
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.rs$')

if [ -n "$FILES" ]; then
    # Only run coverage if Rust files changed
    echo "Rust files changed, running coverage..."
    cargo llvm-cov --summary-only
fi
</code></pre>
<h3 id="parallel-execution"><a class="header" href="#parallel-execution">Parallel Execution</a></h3>
<p>Run independent checks in parallel:</p>
<pre><code class="language-bash"># Run formatting and linting in parallel
cargo fmt --check &amp;
FMT_PID=$!

cargo clippy -- -D warnings &amp;
CLIPPY_PID=$!

wait $FMT_PID || FAIL=1
wait $CLIPPY_PID || FAIL=1
</code></pre>
<p>This can halve hook execution time.</p>
<h3 id="progressive-enhancement"><a class="header" href="#progressive-enhancement">Progressive Enhancement</a></h3>
<p>Start with warnings, graduate to errors:</p>
<pre><code class="language-bash"># Phase 1: Warn about complexity
if pmat analyze complexity --max-cyclomatic 20 2&gt;&amp;1 | grep -q "exceeds"; then
    echo "‚ö†Ô∏è  Complexity warning (will be enforced next month)"
fi

# Phase 2 (after deadline): Make it an error
# if pmat analyze complexity --max-cyclomatic 20 2&gt;&amp;1 | grep -q "exceeds"; then
#     FAIL=1
# fi
</code></pre>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="hook-takes-too-long"><a class="header" href="#hook-takes-too-long">‚ÄúHook takes too long!‚Äù</a></h3>
<p><strong>Solution</strong>: Run checks manually during development, not just at commit time:</p>
<pre><code class="language-bash"># During development
cargo watch -x test -x clippy

# Then commit is fast
git commit -m "..."
</code></pre>
<h3 id="hook-fails-but-the-check-passes-manually"><a class="header" href="#hook-fails-but-the-check-passes-manually">‚ÄúHook fails but the check passes manually!‚Äù</a></h3>
<p><strong>Solution</strong>: Environment differences. Ensure the hook uses the same environment:</p>
<pre><code class="language-bash"># In hook, print environment
echo "PATH: $PATH"
echo "Rust version: $(rustc --version)"
</code></pre>
<p>Match your shell environment.</p>
<h3 id="hook-doesnt-run-at-all"><a class="header" href="#hook-doesnt-run-at-all">‚ÄúHook doesn‚Äôt run at all!‚Äù</a></h3>
<p><strong>Solution</strong>: Ensure Git hooks are enabled:</p>
<pre><code class="language-bash">git config --get core.hooksPath  # Should be empty or .git/hooks

# If custom hooks path, move hook there
</code></pre>
<h3 id="hook-runs-old-version-of-checks"><a class="header" href="#hook-runs-old-version-of-checks">‚ÄúHook runs old version of checks!‚Äù</a></h3>
<p><strong>Solution</strong>: The hook is static. Regenerate it after changing quality standards:</p>
<pre><code class="language-bash">cp scripts/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
</code></pre>
<p>Or make the hook call a script that‚Äôs version-controlled:</p>
<pre><code class="language-bash"># .git/hooks/pre-commit
#!/bin/bash
exec ./scripts/quality-checks.sh
</code></pre>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Pre-commit hooks are your first line of defense against quality regressions. They:</p>
<ul>
<li><strong>Automate quality enforcement</strong> at the moment of commit</li>
<li><strong>Provide immediate feedback</strong> on quality violations</li>
<li><strong>Prevent technical debt</strong> from entering the codebase</li>
<li><strong>Ensure consistency</strong> across all contributors</li>
</ul>
<p>pforge‚Äôs pre-commit hook runs eight quality gates, blocking commits that fail any check. This enforces uncompromising standards and prevents the quality erosion that plagues most projects.</p>
<p>Hooks may slow down commits initially, but the time saved debugging production issues and managing technical debt far outweighs the upfront cost.</p>
<p>The next chapter explores <strong>PMAT</strong>, the tool that powers complexity analysis, SATD detection, and TDG scoring.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch08-00-quality-gates.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch08-02-pmat.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch08-00-quality-gates.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch08-02-pmat.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
