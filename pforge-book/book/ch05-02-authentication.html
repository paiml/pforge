<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Authentication - pforge: EXTREME TDD for MCP Servers</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Build production-ready MCP servers with EXTREME Test-Driven Development - 5-minute cycles, zero tolerance quality gates">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">pforge: EXTREME TDD for MCP Servers</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/paiml/pforge" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/paiml/pforge/edit/main/pforge-book/src/ch05-02-authentication.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="api-authentication"><a class="header" href="#api-authentication">API Authentication</a></h1>
<p>HTTP handlers support multiple authentication strategies. This chapter covers implementing Bearer tokens, API keys, Basic Auth, and OAuth patterns.</p>
<h2 id="bearer-token-authentication"><a class="header" href="#bearer-token-authentication">Bearer Token Authentication</a></h2>
<h3 id="static-token-configuration"><a class="header" href="#static-token-configuration">Static Token (Configuration)</a></h3>
<pre><code class="language-yaml">tools:
  - type: http
    name: auth_api_call
    endpoint: "https://api.example.com/data"
    method: GET
    headers:
      Authorization: "Bearer {{access_token}}"
    params:
      access_token:
        type: string
        required: true
        description: "API access token"
</code></pre>
<p><strong>Usage</strong>:</p>
<pre><code class="language-json">{
  "tool": "auth_api_call",
  "params": {
    "access_token": "eyJhbGc..."
  }
}
</code></pre>
<h3 id="dynamic-token-environment-variable"><a class="header" href="#dynamic-token-environment-variable">Dynamic Token (Environment Variable)</a></h3>
<pre><code class="language-yaml">headers:
  Authorization: "Bearer ${API_TOKEN}"  # From environment
</code></pre>
<h2 id="api-key-authentication"><a class="header" href="#api-key-authentication">API Key Authentication</a></h2>
<h3 id="header-based-api-key"><a class="header" href="#header-based-api-key">Header-Based API Key</a></h3>
<pre><code class="language-yaml">tools:
  - type: http
    name: api_key_call
    endpoint: "https://api.example.com/resource"
    method: GET
    headers:
      X-API-Key: "{{api_key}}"
    params:
      api_key: { type: string, required: true }
</code></pre>
<h3 id="query-parameter-api-key"><a class="header" href="#query-parameter-api-key">Query Parameter API Key</a></h3>
<pre><code class="language-yaml">tools:
  - type: http
    name: query_key_call
    endpoint: "https://api.example.com/resource"
    method: GET
    query:
      api_key: "{{api_key}}"
    params:
      api_key: { type: string, required: true }
</code></pre>
<h2 id="basic-authentication"><a class="header" href="#basic-authentication">Basic Authentication</a></h2>
<h3 id="yaml-configuration"><a class="header" href="#yaml-configuration">YAML Configuration</a></h3>
<pre><code class="language-yaml">tools:
  - type: http
    name: basic_auth_call
    endpoint: "https://api.example.com/secure"
    method: GET
    auth:
      type: basic
      username: "{{username}}"
      password: "{{password}}"
    params:
      username: { type: string, required: true }
      password: { type: string, required: true }
</code></pre>
<h3 id="native-handler-implementation"><a class="header" href="#native-handler-implementation">Native Handler Implementation</a></h3>
<pre><code class="language-rust">use reqwest::Client;
use schemars::JsonSchema;
use serde::{Deserialize, Serialize};

#[derive(Deserialize, JsonSchema)]
struct BasicAuthInput {
    username: String,
    password: String,
    resource: String,
}

#[derive(Serialize, JsonSchema)]
struct ApiResponse {
    status: u16,
    body: serde_json::Value,
}

async fn handle(&amp;self, input: BasicAuthInput) -&gt; Result&lt;ApiResponse&gt; {
    let client = Client::new();

    let response = client
        .get(&amp;format!("https://api.example.com/{}", input.resource))
        .basic_auth(&amp;input.username, Some(&amp;input.password))
        .send()
        .await?;

    Ok(ApiResponse {
        status: response.status().as_u16(),
        body: response.json().await?,
    })
}</code></pre>
<h2 id="oauth-20-patterns"><a class="header" href="#oauth-20-patterns">OAuth 2.0 Patterns</a></h2>
<h3 id="client-credentials-flow"><a class="header" href="#client-credentials-flow">Client Credentials Flow</a></h3>
<pre><code class="language-rust">use serde::{Deserialize, Serialize};
use reqwest::Client;

#[derive(Deserialize)]
struct TokenResponse {
    access_token: String,
    token_type: String,
    expires_in: u64,
}

#[derive(Deserialize, JsonSchema)]
struct OAuthInput {
    client_id: String,
    client_secret: String,
    resource: String,
}

async fn handle(&amp;self, input: OAuthInput) -&gt; Result&lt;ApiResponse&gt; {
    // Step 1: Get access token
    let token_response: TokenResponse = Client::new()
        .post("https://oauth.example.com/token")
        .form(&amp;[
            ("grant_type", "client_credentials"),
            ("client_id", &amp;input.client_id),
            ("client_secret", &amp;input.client_secret),
        ])
        .send()
        .await?
        .json()
        .await?;

    // Step 2: Use access token
    let response = Client::new()
        .get(&amp;format!("https://api.example.com/{}", input.resource))
        .bearer_auth(&amp;token_response.access_token)
        .send()
        .await?;

    Ok(ApiResponse {
        status: response.status().as_u16(),
        body: response.json().await?,
    })
}</code></pre>
<h3 id="token-refresh-flow"><a class="header" href="#token-refresh-flow">Token Refresh Flow</a></h3>
<pre><code class="language-rust">use std::sync::Arc;
use tokio::sync::RwLock;
use std::time::{SystemTime, UNIX_EPOCH};

struct TokenCache {
    access_token: String,
    expires_at: u64,
}

pub struct OAuthHandler {
    client_id: String,
    client_secret: String,
    token_cache: Arc&lt;RwLock&lt;Option&lt;TokenCache&gt;&gt;&gt;,
    client: Client,
}

impl OAuthHandler {
    async fn get_access_token(&amp;self) -&gt; Result&lt;String&gt; {
        let now = SystemTime::now()
            .duration_since(UNIX_EPOCH)?
            .as_secs();

        // Check cache
        {
            let cache = self.token_cache.read().await;
            if let Some(token) = cache.as_ref() {
                if token.expires_at &gt; now + 60 {  // 1 minute buffer
                    return Ok(token.access_token.clone());
                }
            }
        }

        // Refresh token
        let response: TokenResponse = self.client
            .post("https://oauth.example.com/token")
            .form(&amp;[
                ("grant_type", "client_credentials"),
                ("client_id", &amp;self.client_id),
                ("client_secret", &amp;self.client_secret),
            ])
            .send()
            .await?
            .json()
            .await?;

        let expires_at = now + response.expires_in;

        // Update cache
        {
            let mut cache = self.token_cache.write().await;
            *cache = Some(TokenCache {
                access_token: response.access_token.clone(),
                expires_at,
            });
        }

        Ok(response.access_token)
    }

    async fn handle(&amp;self, input: OAuthInput) -&gt; Result&lt;ApiResponse&gt; {
        let access_token = self.get_access_token().await?;

        let response = self.client
            .get(&amp;format!("https://api.example.com/{}", input.resource))
            .bearer_auth(&amp;access_token)
            .send()
            .await?;

        Ok(ApiResponse {
            status: response.status().as_u16(),
            body: response.json().await?,
        })
    }
}</code></pre>
<h2 id="jwt-authentication"><a class="header" href="#jwt-authentication">JWT Authentication</a></h2>
<h3 id="jwt-token-generation"><a class="header" href="#jwt-token-generation">JWT Token Generation</a></h3>
<pre><code class="language-rust">use jsonwebtoken::{encode, Header, EncodingKey};
use serde::{Serialize, Deserialize};

#[derive(Serialize, Deserialize)]
struct Claims {
    sub: String,
    exp: u64,
    iat: u64,
}

async fn handle(&amp;self, input: JwtInput) -&gt; Result&lt;ApiResponse&gt; {
    let now = SystemTime::now()
        .duration_since(UNIX_EPOCH)?
        .as_secs();

    let claims = Claims {
        sub: input.user_id,
        iat: now,
        exp: now + 3600,  // 1 hour
    };

    let token = encode(
        &amp;Header::default(),
        &amp;claims,
        &amp;EncodingKey::from_secret(input.secret.as_bytes()),
    )?;

    let response = self.client
        .get(&amp;input.url)
        .bearer_auth(&amp;token)
        .send()
        .await?;

    Ok(ApiResponse {
        status: response.status().as_u16(),
        body: response.json().await?,
    })
}</code></pre>
<h2 id="hmac-signature-authentication"><a class="header" href="#hmac-signature-authentication">HMAC Signature Authentication</a></h2>
<h3 id="aws-signature-v4-example"><a class="header" href="#aws-signature-v4-example">AWS Signature V4 Example</a></h3>
<pre><code class="language-rust">use hmac::{Hmac, Mac};
use sha2::Sha256;
use hex::encode;

type HmacSha256 = Hmac&lt;Sha256&gt;;

fn sign_request(
    secret: &amp;str,
    method: &amp;str,
    path: &amp;str,
    timestamp: u64,
) -&gt; String {
    let string_to_sign = format!("{}\n{}\n{}", method, path, timestamp);

    let mut mac = HmacSha256::new_from_slice(secret.as_bytes())
        .expect("HMAC creation failed");
    mac.update(string_to_sign.as_bytes());

    encode(mac.finalize().into_bytes())
}

async fn handle(&amp;self, input: SignedInput) -&gt; Result&lt;ApiResponse&gt; {
    let timestamp = SystemTime::now()
        .duration_since(UNIX_EPOCH)?
        .as_secs();

    let signature = sign_request(
        &amp;input.secret,
        "GET",
        &amp;input.path,
        timestamp,
    );

    let response = self.client
        .get(&amp;format!("https://api.example.com{}", input.path))
        .header("X-Timestamp", timestamp.to_string())
        .header("X-Signature", signature)
        .send()
        .await?;

    Ok(ApiResponse {
        status: response.status().as_u16(),
        body: response.json().await?,
    })
}</code></pre>
<h2 id="authentication-best-practices"><a class="header" href="#authentication-best-practices">Authentication Best Practices</a></h2>
<h3 id="1-never-hardcode-secrets"><a class="header" href="#1-never-hardcode-secrets">1. Never Hardcode Secrets</a></h3>
<pre><code class="language-yaml"># BAD
headers:
  Authorization: "Bearer hardcoded_token_123"

# GOOD
headers:
  Authorization: "Bearer {{access_token}}"
params:
  access_token: { type: string, required: true }
</code></pre>
<h3 id="2-use-environment-variables"><a class="header" href="#2-use-environment-variables">2. Use Environment Variables</a></h3>
<pre><code class="language-rust">use std::env;

let api_key = env::var("API_KEY")
    .map_err(|_| Error::Config("API_KEY not set".into()))?;</code></pre>
<h3 id="3-implement-token-rotation"><a class="header" href="#3-implement-token-rotation">3. Implement Token Rotation</a></h3>
<pre><code class="language-rust">// Rotate tokens before expiry
if token.expires_at - now &lt; 300 {  // 5 minutes before expiry
    token = refresh_token().await?;
}</code></pre>
<h3 id="4-secure-token-storage"><a class="header" href="#4-secure-token-storage">4. Secure Token Storage</a></h3>
<pre><code class="language-rust">use keyring::Entry;

// Store token securely
let entry = Entry::new("pforge", "api_token")?;
entry.set_password(&amp;token)?;

// Retrieve token
let token = entry.get_password()?;</code></pre>
<h2 id="testing-authentication"><a class="header" href="#testing-authentication">Testing Authentication</a></h2>
<h3 id="mock-oauth-server"><a class="header" href="#mock-oauth-server">Mock OAuth Server</a></h3>
<pre><code class="language-rust">#[tokio::test]
async fn test_oauth_flow() {
    let mock_server = MockServer::start().await;

    // Mock token endpoint
    Mock::given(method("POST"))
        .and(path("/token"))
        .respond_with(ResponseTemplate::new(200)
            .set_body_json(json!({
                "access_token": "test_token",
                "token_type": "Bearer",
                "expires_in": 3600
            })))
        .mount(&amp;mock_server)
        .await;

    // Mock API endpoint
    Mock::given(method("GET"))
        .and(path("/data"))
        .and(header("Authorization", "Bearer test_token"))
        .respond_with(ResponseTemplate::new(200)
            .set_body_json(json!({"data": "success"})))
        .mount(&amp;mock_server)
        .await;

    // Test handler
    let handler = OAuthHandler::new(
        "client_id".to_string(),
        "client_secret".to_string(),
        mock_server.uri(),
    );

    let result = handler.handle(OAuthInput {
        resource: "data".to_string(),
    }).await.unwrap();

    assert_eq!(result.status, 200);
}</code></pre>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>Chapter 5.3 covers HTTP error handling, including retry strategies, circuit breakers, and graceful degradation patterns.</p>
<hr />
<blockquote>
<p>“Authentication is trust. Handle it with care.” - pforge security principle</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ch05-01-http-config.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ch05-03-error-handling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ch05-01-http-config.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ch05-03-error-handling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="ace.js"></script>
        <script src="editor.js"></script>
        <script src="mode-rust.js"></script>
        <script src="theme-dawn.js"></script>
        <script src="theme-tomorrow_night.js"></script>

        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
